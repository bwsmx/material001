<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>People Counter</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root { --bg:#ffffff; --fg:#111; --muted:#666; --border:#e5e5e5; --ok:#10b981; --warn:#f59e0b; --danger:#f59e0b; --over:#dc2626; }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .app{min-height:100%;display:flex;flex-direction:column}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:2}
    .title{font-weight:600;letter-spacing:-.01em}
    .chip{display:inline-flex;align-items:center;gap:6px;margin-left:8px;padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:#333;background:#fff}
    .iconbtn{border:1px solid var(--border);background:#fff;padding:8px 10px;border-radius:12px;font-size:14px}
    .wrap{width:100%;max-width:520px;margin:0 auto;padding:20px 16px 36px}
    .bar{height:10px;background:#eee;border-radius:999px;overflow:hidden}
    .fill{height:100%;width:0%;transition:width .2s linear}
    .meta{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--muted);margin-top:6px}
    .big{font-size:88px;line-height:1;font-weight:700;letter-spacing:-.02em;margin:20px 0 6px}
    .sub{font-size:13px;color:var(--muted)}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:24px}
    .btn{height:96px;border-radius:18px;border:1px solid var(--border);font-size:40px;font-weight:700;background:#f7f7f7}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .rowc{display:flex;justify-content:center;margin-top:10px}
    .ghostbtn{border:1px dashed var(--border);background:#fff;color:#333;border-radius:12px;padding:8px 12px;font-size:14px}
    .status{font-size:12px;color:var(--muted)}

    .sheetBack{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:end;z-index:10}
    .sheet{background:#fff;width:100%;max-height:90%;overflow:auto;border-radius:16px 16px 0 0;padding:12px}
    .sheet.desktop{max-width:720px;margin:40px auto;border-radius:16px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:8px 0}
    .label{font-size:14px}
    .input{width:160px;padding:8px 10px;border:1px solid var(--border);border-radius:12px;font-size:14px}
    .input.wide{width:100%;max-width:100%}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff;font-size:13px}
    .toggle{width:42px;height:26px;background:#ddd;border-radius:999px;position:relative;cursor:pointer}
    .toggle .dot{position:absolute;top:3px;left:3px;width:20px;height:20px;border-radius:50%;background:#fff;transition:left .15s;border:1px solid #ddd}
    .toggle.on{background:#111}
    .toggle.on .dot{left:19px}
    .section{border-top:1px solid var(--border);margin-top:8px;padding-top:8px}
    .small{font-size:12px;color:var(--muted)}
    .list{margin:8px 0;padding:0;list-style:none}
    .item{display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #f0f0f0;font-size:13px}
    .mutedBtn{background:#fafafa}
    @media(min-width:768px){.sheetBack{align-items:center}.sheet{border-radius:16px}.sheet.desktop{max-height:80%}}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="title">People Counter <span id="counterChip" class="chip" title="Active counter">üè∑Ô∏è <span id="chipText">Main Entrance</span></span></div>
      <button id="settingsBtn" class="iconbtn" aria-label="Settings">‚öôÔ∏è</button>
    </div>

    <div class="wrap">
      <div class="bar"><div id="fill" class="fill"></div></div>
      <div class="meta"><div id="maxLabel">Max 300</div><div><span id="syncDot" style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#bbb;margin-right:6px"></span><span id="syncLabel" class="status">Offline</span> ¬∑ <span id="pctLabel">0%</span></div></div>

      <div id="count" class="big">0</div>
      <div id="sub" class="sub">Inside ¬∑ Total today 0 ¬∑ Remaining 300</div>

      <div class="grid2">
        <button id="exitBtn" class="btn" aria-label="Exit">‚àí</button>
        <button id="enterBtn" class="btn primary" aria-label="Enter">+</button>
      </div>
      <div class="rowc"><button id="undoMainBtn" class="ghostbtn" aria-label="Undo last action">Undo</button></div>
    </div>
  </div>

  <div id="sheetBack" class="sheetBack" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
    <div class="sheet desktop" id="sheet" onclick="event.stopPropagation()">
      <div class="row">
        <div id="sheetTitle" class="title">Settings</div>
        <button id="doneBtn" class="iconbtn">Done</button>
      </div>

      <!-- Event first -->
      <div class="section" style="border-top:none;margin-top:0;padding-top:0">
        <div class="row"><div class="label">Event</div><div></div></div>
        <div class="row">
          <div class="label">Event name</div>
          <div style="flex:1;max-width:420px"><input id="eventNameInput" class="input wide" placeholder="Feria Material 2025" /></div>
        </div>
        <div class="row">
          <div class="label">Event code (for logs)</div>
          <div><input id="sessionInput" class="input" placeholder="e.g. FM25-Thu" /></div>
        </div>
        <div class="small" style="margin-top:-4px">Used for syncing & reports. Leave the default date, or set a short code like "FM25-Thu".</div>
        <div class="row">
          <div class="label">Day</div>
          <div><button id="newDayBtn" class="pill">New day</button></div>
        </div>
        <div class="small" id="sinceLabel">Current start: ‚Äî</div>
      </div>

      <!-- Counters -->
      <div class="section">
        <div class="row"><div class="label">Counters</div>
          <div class="small">Create & select which counter this device controls. Cap/lockout saved per counter.</div>
        </div>
        <ul id="countersList" class="list"></ul>
        <div class="row">
          <div class="label">Add counter</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
            <input id="newCounterLabel" class="input" placeholder="Label e.g. Terrace Stairs" />
            <button id="addCounterBtn" class="pill mutedBtn">Add</button>
          </div>
        </div>
      </div>

      <!-- Connectivity -->
      <div class="section">
        <div class="row"><div class="label">Connectivity</div>
          <div class="small">Endpoint is optional; the app works offline and queues events.</div>
        </div>
        <div class="row">
          <div class="label">Endpoint URL</div>
          <div style="flex:1;max-width:420px">
            <input id="endpointInput" class="input wide" placeholder="https://script.google.com/macros/s/AKf.../exec" />
          </div>
        </div>
        <div class="row">
          <div class="label">Actions</div>
          <div>
            <button id="syncNowBtn" class="pill">Sync now</button>
            <details style="display:inline-block;margin-left:6px"><summary class="small" style="cursor:pointer">Advanced</summary>
              <button id="testEndpointBtn" class="pill" style="margin-top:6px">Test endpoint</button>
            </details>
          </div>
        </div>
      </div>

      <!-- Security -->
      <div class="section">
        <div class="row"><div class="label">Security</div><div></div></div>
        <div class="row">
          <div class="label">Settings PIN</div>
          <div>
            <input id="pinInput" type="password" class="input" placeholder="Set 4‚Äëdigit PIN" />
            <button id="setPinBtn" class="pill">Save PIN</button>
          </div>
        </div>
        <div class="small">If empty, default PIN is 1234.</div>
      </div>

      <!-- History & export at the end -->
      <div class="section">
        <div class="row"><div class="label">Export</div>
          <div>
            <button id="csvBtn" class="pill">Download CSV</button>
          </div>
        </div>
        <div class="row"><div class="label">Recent activity</div><div class="small">Last 5 for active counter</div></div>
        <ul id="history" class="list"></ul>
      </div>

    </div>
  </div>

  <script>
    // ---- Safe storage helpers ----
    const KEYS = { state:'pc_state_v10', pin:'pc_pin_v10', endpoint:'pc_endpoint_v10', session:'pc_session_v10', eventName:'pc_event_name_v10', counter:'pc_counter_v10', counterLabel:'pc_counter_label_v10', counters:'pc_counters_v10', queue:'pc_queue_v10', migrated:'pc_migrated_v10' };
    const sget = (k, d)=>{ try{ const v = localStorage.getItem(k); return v==null? d : JSON.parse(v);}catch{ return d; } };
    const sset = (k, v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} };

    // ---- Legacy key migration ----
    function readLegacy(keys){ for(const k of keys){ try{ const v = localStorage.getItem(k); if(v!=null) return JSON.parse(v);}catch{} } return null; }

    // ---- State ----
    const state = sget(KEYS.state, { inside:0, total:0, peak:0, history:[], createdAt:Date.now() });
    let pin = sget(KEYS.pin, '1234');

    let endpoint = sget(KEYS.endpoint, '') || readLegacy(['pc_endpoint_v9','pc_endpoint_v8','pc_endpoint_v7']) || '';
    let sessionId = sget(KEYS.session, new Date().toISOString().slice(0,10)) || readLegacy(['pc_session_v9','pc_session_v8','pc_session_v7']) || new Date().toISOString().slice(0,10);
    let eventName = sget(KEYS.eventName, '');
    let counterId = sget(KEYS.counter, 'main-entrance') || readLegacy(['pc_counter_v9','pc_counter_v8','pc_counter_v7']) || 'main-entrance';
    let counterLabel = sget(KEYS.counterLabel, 'Main Entrance') || readLegacy(['pc_counter_label_v9','pc_counter_label_v8','pc_counter_label_v7']) || 'Main Entrance';

    let counters = sget(KEYS.counters, [
      { id:'main-entrance', label:'Main Entrance', cap: 300, lockout: false },
      { id:'terrace-stairs', label:'Terrace Stairs', cap: 300, lockout: false }
    ]);
    (function ensureActive(){
      if(!counters.find(c=>c.id===counterId)) counters.push({id:counterId, label:counterLabel, cap: 300, lockout: false});
      counters = counters.map(c=>({ id:c.id, label:c.label, cap: (typeof c.cap==='number'&&c.cap>0)? c.cap : 300, lockout: !!c.lockout }));
    })();

    (function maybeMigrate(){
      if(!sget(KEYS.migrated,false)){
        sset(KEYS.endpoint, endpoint); sset(KEYS.session, sessionId); sset(KEYS.eventName, eventName); sset(KEYS.counter, counterId); sset(KEYS.counterLabel, counterLabel); sset(KEYS.counters, counters); sset(KEYS.migrated,true);
      }
    })();

    let queue = sget(KEYS.queue, []);

    // ---- Elements ----
    const countEl = document.getElementById('count');
    const subEl = document.getElementById('sub');
    const fillEl = document.getElementById('fill');
    const pctLabel = document.getElementById('pctLabel');
    const maxLabel = document.getElementById('maxLabel');
    const enterBtn = document.getElementById('enterBtn');
    const exitBtn = document.getElementById('exitBtn');
    const undoMainBtn = document.getElementById('undoMainBtn');

    const sheetBack = document.getElementById('sheetBack');
    const settingsBtn = document.getElementById('settingsBtn');
    const doneBtn = document.getElementById('doneBtn');

    const newDayBtn = document.getElementById('newDayBtn');
    const sinceLabel = document.getElementById('sinceLabel');

    const eventNameInput = document.getElementById('eventNameInput');
    const countersList = document.getElementById('countersList');
    const newCounterLabel = document.getElementById('newCounterLabel');
    const addCounterBtn = document.getElementById('addCounterBtn');

    const csvBtn = document.getElementById('csvBtn');

    const endpointInput = document.getElementById('endpointInput');
    const syncNowBtn = document.getElementById('syncNowBtn');
    const testEndpointBtn = document.getElementById('testEndpointBtn');
    const syncLabel = document.getElementById('syncLabel');
    const syncDot = document.getElementById('syncDot');

    const pinInput = document.getElementById('pinInput');
    const setPinBtn = document.getElementById('setPinBtn');

    const chipText = document.getElementById('chipText');
    const historyEl = document.getElementById('history');

    // ---- Utils ----
    const fmtTime = (t)=> new Date(t).toLocaleTimeString();
    const fmtDate = (t)=> new Date(t).toLocaleString();
    const clamp0 = (n)=> Math.max(0, n|0);
    const percent = (a,b)=> (!b||b<=0)?0:Math.min(100, Math.max(0, Math.round((a/b)*100)));
    const haptic = ()=>{ try{ if(navigator.vibrate) navigator.vibrate(10);}catch{} };
    const slugify = (s)=> s.toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

    function active(){ return counters.find(c=>c.id===counterId) || counters[0]; }

    function replay(history, createdAt){
      let start=-1; for(let i=history.length-1;i>=0;i--){ if(history[i].type==='newDay'){ start=i; break; } }
      let inside=0,total=0,peak=0; let since=createdAt; if(start>=0) since = history[start].t || since;
      for(let i=start+1;i<history.length;i++){
        const h = history[i];
        if(h.counter_id!==counterId) continue;
        if(h.type==='enter'){ inside += (h.amount||0); total += (h.amount||0); }
        else if(h.type==='exit'){ inside = Math.max(0, inside - (h.amount||0)); }
        else if(h.type==='adjust'){ const a=h.amount||0; inside = Math.max(0, inside + a); if(a>0) total += a; }
        else if(h.type==='clear'){ inside = 0; }
        else if(h.type==='newDay'){ inside=0; total=0; peak=0; since=h.t||since; }
        peak = Math.max(peak, inside);
      }
      return { inside, total, peak, since };
    }

    function save(){ sset(KEYS.state,state); sset(KEYS.pin,pin); sset(KEYS.endpoint,endpoint); sset(KEYS.session,sessionId); sset(KEYS.eventName,eventName); sset(KEYS.counter,counterId); sset(KEYS.counterLabel,counterLabel); sset(KEYS.counters,counters); sset(KEYS.queue,queue); }

    // ---- Actions ----
    function log(entry){ const a = active(); const e = { ...entry, t: Date.now(), session_id: sessionId, counter_id: a.id, counter_label: a.label }; state.history.push(e); queue.push(e); save(); }
    function enter(){ const a=active(); const n=1; const proj=state.inside+n; if(a.lockout && proj>a.cap){ log({type:'enter',amount:0,blocked:true}); render(); return;} state.inside=proj; state.total+=n; state.peak=Math.max(state.peak,state.inside); log({type:'enter',amount:n}); haptic(); render(); }
    function exit(){ const n=1; state.inside=Math.max(0,state.inside-n); log({type:'exit',amount:n}); haptic(); render(); }
    function adjust(d){ const a=active(); d=(d|0); if(d===0) return; const proj=Math.max(0,state.inside+d); if(a.lockout && d>0 && proj>a.cap){ log({type:'adjust',amount:0,blocked:true}); render(); return;} state.inside=proj; if(d>0) state.total+=d; state.peak=Math.max(state.peak,state.inside); log({type:'adjust',amount:d}); render(); }
    function undo(){ if(!state.history.length) return; state.history.pop(); const r=replay(state.history,state.createdAt); state.inside=r.inside; state.total=r.total; state.peak=r.peak; haptic(); render(); }
    function newDay(){ if(!confirm('Start a new day? This resets inside/total for reporting.')) return; log({type:'newDay'}); const r=replay(state.history,Date.now()); state.inside=r.inside; state.total=r.total; state.peak=r.peak; state.createdAt=Date.now(); render(); }

    function exportCSV(){
      const rows=[["timestamp","session_id","counter_id","counter_label","type","amount","inside_after","blocked"]];
      let insideByCounter = {};
      for(const h of state.history){
        const cid = h.counter_id || 'unknown';
        if(!insideByCounter[cid]) insideByCounter[cid]=0;
        if(h.type==='enter'){ insideByCounter[cid]+=(h.amount||0); }
        else if(h.type==='exit'){ insideByCounter[cid]=Math.max(0,insideByCounter[cid]-(h.amount||0)); }
        else if(h.type==='adjust'){ insideByCounter[cid]=Math.max(0,insideByCounter[cid]+(h.amount||0)); }
        else if(h.type==='clear'){ insideByCounter[cid]=0; }
        else if(h.type==='newDay'){ insideByCounter[cid]=0; }
        rows.push([new Date(h.t).toISOString(),h.session_id,h.counter_id,h.counter_label,h.type,h.amount??"",insideByCounter[cid],h.blocked?"yes":""]);
      }
      const csv=rows.map(r=>r.join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`people_counter_${sessionId}.csv`; a.click(); URL.revokeObjectURL(a.href);
    }

    // ---- Counter management ----
    function setActiveCounter(id){
      const c = counters.find(x=>x.id===id);
      if(!c) return;
      counterId = c.id; counterLabel = c.label;
      const r = replay(state.history, state.createdAt);
      state.inside=r.inside; state.total=r.total; state.peak=r.peak;
      save(); render();
    }
    function addCounter(){
      const label = (newCounterLabel.value||'').trim();
      if(!label) { alert('Enter a label'); return; }
      let id = slugify(label) || 'counter';
      let base=id, i=2; while(counters.find(c=>c.id===id)) { id = base+'-'+i++; }
      counters.push({id, label, cap: 300, lockout: false}); newCounterLabel.value=''; save(); render();
    }
    function deleteCounter(id){
      const idx = counters.findIndex(c=>c.id===id);
      if(idx<0) return;
      if(counters.length<=1){ alert('Keep at least one counter'); return; }
      const deletingActive = counters[idx].id===counterId;
      counters.splice(idx,1);
      if(deletingActive){ const c = counters[0]; counterId=c.id; counterLabel=c.label; }
      const r = replay(state.history, state.createdAt);
      state.inside=r.inside; state.total=r.total; state.peak=r.peak;
      save(); render();
    }

    function renderCounters(){
      countersList.innerHTML='';
      for(const c of counters){
        const li = document.createElement('li'); li.className='item';
        li.innerHTML = `
          <div style="display:flex;align-items:center;gap:10px">
            <input type="radio" name="counterSel" value="${c.id}" ${c.id===counterId?'checked':''}/>
            <input class="input" data-label-for="${c.id}" style="width:180px" value="${c.label}" />
          </div>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end">
            <span class="small">Cap</span>
            <input data-cap-for="${c.id}" class="input" style="width:90px" type="number" min="1" value="${c.cap}" />
            <span class="small">Lock</span>
            <label class="toggle ${c.lockout?'on':''}" data-lock-for="${c.id}"><div class="dot"></div></label>
            <button class="pill mutedBtn" data-del="${c.id}">Delete</button>
          </div>`;
        countersList.appendChild(li);
      }
      // attach events
      countersList.querySelectorAll('input[name="counterSel"]').forEach(r=>{
        r.addEventListener('change', ()=> setActiveCounter(r.value));
      });
      countersList.querySelectorAll('input[data-label-for]').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const id = inp.getAttribute('data-label-for');
          const c = counters.find(x=>x.id===id); if(!c) return;
          c.label = inp.value; if(c.id===counterId){ counterLabel=c.label; chipText.textContent=counterLabel; }
          save(); // do not re-render on every keystroke
        });
        inp.addEventListener('blur', ()=>{ render(); });
        inp.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ inp.blur(); }});
      });
      countersList.querySelectorAll('input[data-cap-for]').forEach(inp=>{
        inp.addEventListener('input', ()=>{
          const id = inp.getAttribute('data-cap-for');
          const c = counters.find(x=>x.id===id); if(!c) return;
          const n = Math.max(1, Math.floor(Number(inp.value)||0));
          c.cap = n; save();
        });
        inp.addEventListener('blur', ()=>{ render(); });
      });
      countersList.querySelectorAll('[data-lock-for]').forEach(tg=>{
        tg.addEventListener('click', ()=>{
          const id = tg.getAttribute('data-lock-for');
          const c = counters.find(x=>x.id===id); if(!c) return;
          c.lockout = !c.lockout; tg.classList.toggle('on', c.lockout); save();
          if(c.id===counterId) { /* no need to full render */ }
        });
      });
      countersList.querySelectorAll('button[data-del]').forEach(b=>{
        b.addEventListener('click', ()=> deleteCounter(b.getAttribute('data-del')));
      });
    }

    // ---- Rendering ----
    function render(){
      save();
      const a = active();
      chipText.textContent = a.label || a.id;
      const pct = percent(state.inside, a.cap);
      const color = pct>=100? 'var(--over)' : pct>=95? 'var(--danger)' : pct>=80? 'var(--warn)' : 'var(--ok)';
      fillEl.style.width = pct + '%'; fillEl.style.background = color;
      pctLabel.textContent = pct + '%'; maxLabel.textContent = 'Max ' + a.cap;
      countEl.textContent = state.inside;
      subEl.textContent = `Inside ¬∑ Total today ${state.total} ¬∑ Remaining ${Math.max(0, a.cap - state.inside)}`;

      // Connectivity fields
      endpointInput.value = endpoint;
      if(!endpoint){ syncLabel.textContent='Offline (no endpoint)'; syncDot.style.background='#bbb'; }
      else if(navigator.onLine){ syncLabel.textContent = queue.length? `Syncing‚Ä¶ ${queue.length} queued` : 'Online'; syncDot.style.background = queue.length? '#f59e0b' : '#10b981'; }
      else { syncLabel.textContent='Offline'; syncDot.style.background='#bbb'; }

      // Event fields
      eventNameInput.value = eventName;
      document.getElementById('sessionInput').value = sessionId;
      sinceLabel.textContent = 'Current start: ' + fmtDate(state.createdAt);

      // History list last 5 for active
      historyEl.innerHTML = '';
      const items = state.history.filter(h=>h.counter_id===a.id).slice(-5).reverse();
      for(const h of items){
        const li=document.createElement('li'); li.className='item';
        const label = h.blocked? `${h.type} (blocked)` : h.amount!=null? `${h.type} (${h.amount})` : h.type;
        li.innerHTML = `<div>${label} ‚Äî <span class=\"small\">${h.counter_label||h.counter_id}</span></div><div class=\"small\">${fmtTime(h.t)}</div>`;
        historyEl.appendChild(li);
      }

      renderCounters();
    }

    // ---- Events ----
    enterBtn.onclick = enter;
    exitBtn.onclick = exit;
    undoMainBtn.onclick = undo;

    settingsBtn.onclick = ()=> {
      const entered = prompt('Enter 4‚Äëdigit PIN to open Settings:');
      if((entered||'') === String(pin)) sheetBack.style.display = 'flex'; else alert('Incorrect PIN');
    };
    sheetBack.onclick = ()=> { sheetBack.style.display = 'none'; };
    doneBtn.onclick = ()=> { sheetBack.style.display = 'none'; };

    newDayBtn.onclick = newDay;
    csvBtn.onclick = exportCSV;

    // Connectivity inputs (save-only; re-render on blur to avoid input blur issues)
    endpointInput.addEventListener('input', (e)=> { endpoint = e.target.value; save(); });
    endpointInput.addEventListener('blur', ()=>{ render(); });
    syncNowBtn.onclick = ()=> flushQueue();
    testEndpointBtn.onclick = testConnection;

    // Event inputs
    eventNameInput.oninput = (e)=> { eventName = e.target.value; save(); };
    document.getElementById('sessionInput').oninput = (e)=> { sessionId = e.target.value.trim() || sessionId; save(); };

    // Add counter actions
    addCounterBtn.onclick = addCounter;
    newCounterLabel.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ addCounter(); }});

    // Security
    setPinBtn.onclick = ()=> { const v = (pinInput.value||'').trim(); if(!v){ pin='1234'; alert('PIN cleared (defaults to 1234).'); } else if(!/^\d{4}$/.test(v)){ alert('Enter a 4‚Äëdigit PIN'); return; } else { pin=v; alert('PIN updated'); } pinInput.value=''; save(); };

    // ---- Sync layer (Apps Script endpoint) ----
    async function testConnection(){
      if(!endpoint){ alert('Set the Endpoint URL first.'); return; }
      try{
        await new Promise((resolve,reject)=>{
          const img = new Image();
          const t = Date.now();
          img.onload = ()=>resolve();
          img.onerror = ()=>reject(new Error('Image ping failed'));
          img.src = endpoint + (endpoint.includes('?')?'&':'?') + 'fn=ping&_=' + t;
          setTimeout(()=>reject(new Error('Timeout')), 6000);
        });
        alert('Endpoint reachable');
        return;
      }catch(e){ }
      try{
        const u = new URL(endpoint);
        u.searchParams.set('fn','ping');
        await fetch(u, { method:'GET', mode:'no-cors' });
        alert('Ping sent');
      }catch(e){
        alert('Ping failed: '+e.message);
      }
    }

    async function hydrate(){ if(!endpoint) { render(); return; } try{ const u = new URL(endpoint); u.searchParams.set('fn','state'); u.searchParams.set('session_id', sessionId); u.searchParams.set('counter_id', counterId); const r = await fetch(u, {method:'GET'}); if(!r.ok) throw new Error('HTTP '+r.status); const j = await r.json(); if(j && typeof j.inside==='number'){ state.inside = j.inside; state.total = j.total||state.total; state.peak = Math.max(state.peak||0, j.peak||0); state.createdAt = j.createdAt||state.createdAt; for(const q of queue){ if(q.type==='enter'){ state.inside += (q.amount||0); state.total += (q.amount||0);} else if(q.type==='exit'){ state.inside = Math.max(0, state.inside-(q.amount||0)); } else if(q.type==='adjust'){ const a=q.amount||0; state.inside = Math.max(0, state.inside+a); if(a>0) state.total += a; } else if(q.type==='clear'){ state.inside=0; } }
        }
      } catch(e){ }
      render();
    }

    async function postEvent(ev){
      if(!endpoint) return false;
      try{
        await fetch(endpoint, {
          method:'POST',
          headers:{'Content-Type':'text/plain;charset=utf-8'},
          body: JSON.stringify(ev),
          mode:'no-cors',
          keepalive:true
        });
        return true;
      } catch(e){ return false; }
    }

    async function flushQueue(){ if(!endpoint || !navigator.onLine || !queue.length) { render(); return; } let i=0; while(i<queue.length){ const ok = await postEvent(queue[i]); if(ok){ queue.splice(i,1); } else { break; } save(); render(); } }

    // periodic flush
    setInterval(flushQueue, 5000);

    // --- tiny console tests (opt-in) ---
    function runTests(){
      const out=[]; const assert=(name,cond,details='')=>out.push({name, pass:!!cond, details: cond?'':details});
      // slug uniqueness
      let L=[{id:'a',label:'A'},{id:'a-2',label:'A  '},{id:'a-3',label:'A!'}];
      let id='a', base='a', i=2; while(L.find(c=>c.id===id)) id=base+'-'+i++;
      assert('unique slug increments', id==='a-4', id);
      // replay logic
      const now=Date.now();
      const H=[{type:'enter',amount:3,counter_id:'main-entrance',t:now},{type:'exit',amount:1,counter_id:'main-entrance',t:now+1},{type:'newDay',t:now+2},{type:'enter',amount:2,counter_id:'main-entrance',t:now+3}];
      const r=replay(H,now);
      assert('new day resets counts', r.inside===2 && r.total===2, JSON.stringify(r));
      console.table(out);
      return out;
    }
    if(location.search.includes('test=1')) { runTests(); }

    // Initial
    (function initRecalc(){ const r = replay(state.history, state.createdAt); state.inside=r.inside; state.total=r.total; state.peak=r.peak; })();
    hydrate();
    render();
  </script>
</body>
</html>